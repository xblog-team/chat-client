<!DOCTYPE html>
<html>
<head>
    <title>Chat Application</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
    <style>
        #chat {
            border: 1px solid #ccc;
            width: 300px;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }

        .whisper-text {
            color: blue;
        }
    </style>
</head>
<body>
<h1>Chat Room</h1>
<div style="display: flex;">
    <div id="chat" style="flex: 2;"></div>
    <div id="memberList" style="flex: 1; border: 1px solid #ccc; height: 300px; padding: 10px; overflow-y: scroll;">
        <h2>Members</h2>
        <ul id="members"></ul>
    </div>
</div>
<input type="text" id="messageInput" placeholder="Type your message here"/>
<button onclick="sendMessage()">Send</button>

<script>
    const socket = new SockJS('http://localhost:8888/chat');
    const stompClient = Stomp.over(socket);
    let roomId = null;

    document.addEventListener('DOMContentLoaded', () => {
        stompClient.connect({}, onConnected);
    });

    function onConnected(frame) {
        console.log('Connected: ' + frame);
        subscribeToPrivateQueue();
        findRoom();
    }

    function subscribeToPrivateQueue() {
        stompClient.subscribe('/user/queue/findRoom', onRoomIdReceived);
        stompClient.subscribe('/user/queue/whisper', onWhisperReceived);
    }

    function onRoomIdReceived(response) {
        roomId = response.body;
        console.log('Received roomId: ' + roomId);
        enterRoom(roomId);
    }

    function findRoom() {
        console.log('Finding room...');
        stompClient.send('/app/chat/findRoom', {});
    }

    function enterRoom(roomId) {
        console.log('Entering room: ' + roomId);
        stompClient.subscribe(`/topic/${roomId}/members`, onMembersUpdate);
        stompClient.subscribe(`/topic/${roomId}`, onMessageReceived);

        stompClient.send(`/app/chat/enter/${roomId}`, {}, JSON.stringify({ content: `Hello, I entered room ${roomId}!` }));
    }

    function onMembersUpdate(message) {
        const members = JSON.parse(message.body);
        updateMemberList(members);
    }

    function onMessageReceived(message) {
        const data = JSON.parse(message.body);
        appendMessage(data.sender, data.content);
    }

    function onWhisperReceived(message) {
        const data = JSON.parse(message.body);
        appendMessage(data.sender, data.content, true);
    }

    function appendMessage(sender, content, isWhisper = false) {
        const chatArea = document.getElementById('chat');
        const messageElement = document.createElement('p');

        if (isWhisper) {
            messageElement.className = 'whisper-text';
        }

        messageElement.innerHTML = `<strong>${sender}</strong> ${content}`;
        messageElement.addEventListener('click', () => {
            populateWhisperCommand(sender);
        });

        chatArea.appendChild(messageElement);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function populateWhisperCommand(sender) {
        const messageInput = document.getElementById('messageInput');
        messageInput.value = `/w ${sender} `;
        messageInput.focus();
    }

    function updateMemberList(members) {
        const membersList = document.getElementById('members');
        membersList.innerHTML = '';

        members.forEach(member => {
            const memberElement = document.createElement('li');
            memberElement.textContent = member;
            memberElement.addEventListener('click', () => {
                populateWhisperCommand(member);
            });
            membersList.appendChild(memberElement);
        });
    }

    function sendMessage() {
        const message = document.getElementById('messageInput').value;
        if (message.startsWith("/w")) {
            sendWhisperMessage(message);
        } else if (roomId) {
            sendChatMessage(message);
        } else {
            console.log('Room ID is not set yet.');
        }
    }

    function sendWhisperMessage(message) {
        const [_, receiver, ...contentParts] = message.split(" ");
        const content = contentParts.join(" ");

        if (receiver && content) {
            stompClient.send('/app/chat/whisper', {}, JSON.stringify({ receiver, content }));
            document.getElementById('messageInput').value = '';
            console.log(`Whisper to ${receiver}: ${content}`);
        } else {
            console.log("Invalid whisper command");
        }
    }

    function sendChatMessage(message) {
        stompClient.send(`/app/chat/${roomId}`, {}, message);
        document.getElementById('messageInput').value = '';
    }
</script>
</body>
</html>